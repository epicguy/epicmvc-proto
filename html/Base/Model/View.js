// Generated by CoffeeScript 1.9.2
(function() {
  'use strict';
  var View$Base,
    bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty,
    indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

  View$Base = (function(superClass) {
    extend(View$Base, superClass);

    function View$Base(view_nm, options) {
      this.ex = bind(this.ex, this);
      this.T_if = bind(this.T_if, this);
      this.T_page = bind(this.T_page, this);
      this.handleIt = bind(this.handleIt, this);
      var frames, ix, nm;
      View$Base.__super__.constructor.call(this, view_nm, options);
      frames = E.appGetSetting('frames');
      this.frames = (function() {
        var i, len, ref, results;
        ref = ((function() {
          var results1;
          results1 = [];
          for (nm in frames) {
            results1.push(nm);
          }
          return results1;
        })()).sort();
        results = [];
        for (i = 0, len = ref.length; i < len; i++) {
          ix = ref[i];
          results.push(frames[ix]);
        }
        return results;
      })();
      this.frames.push('X');
      this.did_run = false;
      this.in_run = false;
      if (typeof window !== "undefined" && window !== null) {
        window.oE = this;
      }
      this.defer_it_cnt = 0;
      this.start = false;
    }

    View$Base.prototype.nest_up = function(who) {
      var f;
      f = 'BM/View.nest_up:' + who;
      E.log(f, {
        defer_it_cnt: this.defer_it_cnt
      });
      if (this.defer_it_cnt === 0) {
        if (this.in_run) {
          BLOWUP();
        }
        this.in_run = true;
        this.start = new Date().getTime();
        E.log(f + 'START RUN', {
          frames: this.frames,
          start: this.start
        });
        this.defer_it = {
          promise: null,
          resolve: null
        };
        this.defer_it.promise = new Promise((function(_this) {
          return function(resolve, reject) {
            return _this.defer_it.resolve = resolve;
          };
        })(this));
      }
      return this.defer_it_cnt++;
    };

    View$Base.prototype.nest_dn = function(who) {
      var f;
      f = 'BM/View.nest_dn:' + who;
      E.log(f, {
        defer_it_cnt: this.defer_it_cnt
      });
      if (this.defer_it_cnt > 0) {
        this.defer_it_cnt--;
      }
      if (this.defer_it_cnt === 0) {
        E.log(f + 'END RUN', {
          defer_content: this.defer_content,
          date_diff: new Date().getTime() - this.start
        });
        this.in_run = false;
        E.log(f + 'RESOLVE', {
          modal: this.modal,
          defer_content: this.defer_content
        });
        return this.defer_it.resolve([this.modal, this.defer_content]);
      }
    };

    View$Base.prototype.run = function() {
      var f, flow, layout, modal, ref, ref1, ref2, step, track, who;
      f = 'BM/View.run:';
      who = 'R';
      ref = E.App().getStepPath(), flow = ref[0], track = ref[1], step = ref[2];
      if (modal = E.appFindAttr(flow, track, step, 'modal')) {
        modal = (ref1 = (E.appGetSetting('modals'))[modal]) != null ? ref1 : modal;
      }
      layout = modal != null ? modal : E.appGetSetting('layout', flow, track, step);
      this.N = {};
      this.modal = modal ? true : false;
      this.page_name = (ref2 = (E.appGetS(flow, track, step)).page) != null ? ref2 : step;
      this.did_run = true;
      this.frames[this.frames.length - 1] = layout;
      this.frame_inx = 0;
      this.resetInfo();
      this.nest_up(who);
      this.defer_content = this.kids([['page', {}]]);
      E.log(f + 'after @kids', {
        defer_content: this.defer_content
      });
      this.nest_dn(who);
      return this.defer_it.promise;
    };

    View$Base.prototype.resetInfo = function() {
      this.R = {};
      this.I = {};
      this.P = [{}];
    };

    View$Base.prototype.saveInfo = function() {
      var f, saved_info;
      f = 'BM/View.saveInfo:';
      saved_info = E.merge({}, {
        I: this.I,
        P: this.P
      });
      E.log(f, {
        saved_info: saved_info
      });
      return saved_info;
    };

    View$Base.prototype.restoreInfo = function(saved_info) {
      var f, nm;
      f = 'BM/View.restoreInfo:';
      E.log(f, {
        saved_info: saved_info
      });
      this.resetInfo();
      this.P = saved_info.P;
      this.I = saved_info.I;
      for (nm in this.I) {
        if (!(nm in this.R)) {
          this.R[nm] = this._getMyRow(this.I[nm]);
        }
      }
      E.log(f + 'restored:', {
        P: this.P,
        I: this.I,
        R: this.R
      });
    };

    View$Base.prototype._getMyRow = function(I) {
      var f;
      f = 'BM/View._getMyRow:';
      E.log(f, {
        I: I
      });
      if (I.m != null) {
        return (E[I.m](I.o))[I.c];
      }
      if (!(I.p in this.R)) {
        this.R[I.p] = this._getMyRow(this.I[I.p]);
      }
      if (I.p && I.p in this.R) {
        return this.R[I.p][I.o][I.c];
      }
    };

    View$Base.prototype.getTable = function(nm) {
      var f, i, len, p, rVal, ref;
      f = 'BM/View.getTable:' + nm;
      if (nm === 'Part') {
        E.log(f, {
          P: this.P
        });
      }
      switch (nm) {
        case 'If':
          return [this.N];
        case 'Part':
          rVal = {};
          ref = this.P;
          for (i = 0, len = ref.length; i < len; i++) {
            p = ref[i];
            E.merge(rVal, p);
          }
          return [rVal];
        default:
          E.option.m3(this.view_nm, nm);
          return [];
      }
    };

    View$Base.prototype.invalidateTables = function(view_nm, tbl_nms, deleted_tbl_nms) {
      var f;
      if (!(this.did_run && deleted_tbl_nms.length)) {
        return;
      }
      f = 'BM/View.invalidateTables:';
      E.log(f, {
        view_nm: view_nm,
        tbl_nms: tbl_nms,
        deleted_tbl_nms: deleted_tbl_nms
      });
      m.startComputation();
      m.endComputation();
    };

    View$Base.prototype.handleIt = function(content) {
      var f;
      f = 'BM/View.handleIt:';
      E.log(f + 'top', {
        typeof_content: typeof content
      });
      if (typeof content === 'function') {
        content = content();
      }
      E.log(f + 'bottom', {
        content: content
      });
      return content;
    };

    View$Base.prototype.formatFromSpec = function(val, spec, custom_spec) {
      var f, left, ref, right, str;
      f = 'BM/View.formatFromSpec:';
      E.log(f, {
        val: val,
        spec: spec,
        custom_spec: custom_spec
      });
      switch (spec) {
        case '':
          if (custom_spec) {
            E.option.v2(val, custom_spec);
            return E.custom_filter(val, custom_spec);
          } else {
            return val;
          }
          break;
        case 'count':
          return val != null ? val.length : void 0;
        case 'bool':
          if (val) {
            return true;
          } else {
            return false;
          }
        case 'uriencode':
          return encodeURIComponent(val);
        case 'quo':
          return ((val.replace(/\\/g, '\\\\')).replace(/'/g, '\\\'')).replace(/"/g, '\\"');
        case '1':
          return (String(val))[0];
        case 'lc':
          return (String(val)).toLowerCase();
        case 'ucFirst':
          str = (String(str)).toLowerCase();
          return str.slice(0, 1).toUpperCase() + str.slice(1);
        default:
          if (spec[0] === '?') {
            ref = spec.slice(1).split('?'), left = ref[0], right = ref[1];
            return (val ? left : right != null ? right : '').replace(new RegExp('[%]', 'g'), val);
          } else {
            return E.option.v1(val, spec);
          }
      }
    };

    View$Base.prototype.v3 = function(view_nm, tbl_nm, key, format_spec, custom_spec) {
      var row, val;
      row = (E[view_nm](tbl_nm))[0];
      val = row[key];
      if (format_spec != null) {
        return this.formatFromSpec(val, format_spec, custom_spec);
      } else {
        return val;
      }
    };

    View$Base.prototype.v2 = function(table_ref, col_nm, format_spec, custom_spec) {
      var ans;
      if (col_nm[0] === '_') {
        ans = this.R[table_ref]._[col_nm.slice(1)];
      } else {
        ans = this.R[table_ref][col_nm];
      }
      if (format_spec != null) {
        return this.formatFromSpec(ans, format_spec, custom_spec);
      } else {
        return ans;
      }
    };

    View$Base.prototype.weed = function(attrs) {
      var clean_attrs, f, nm, val;
      f = 'BM/View.weed:';
      clean_attrs = {};
      for (nm in attrs) {
        val = attrs[nm];
        if (nm[0] !== '?') {
          clean_attrs[nm] = val;
        } else {
          if (val) {
            clean_attrs[nm.slice(1)] = val;
          }
        }
      }
      E.log(f, {
        clean_attrs: clean_attrs
      });
      return clean_attrs;
    };

    View$Base.prototype.kids = function(kids) {
      var ans, f, i, ix, kid, len, out, who;
      f = 'BM/View.kids:';
      who = 'K';
      E.log(f + 'top', {
        kids_length: kids.length
      });
      out = [];
      for (ix = i = 0, len = kids.length; i < len; ix = ++i) {
        kid = kids[ix];
        E.log(f, {
          date_diff: new Date().getTime() - this.start
        });
        if ('A' === E.type_oau(kid)) {
          out.push(ix);
          ans = this['T_' + kid[0]](kid[1], kid[2]);
          E.log(f + 'CHECK FOR THEN', {
            then: ((ans != null ? ans.then : void 0) ? 'YES' : 'NO'),
            ans: ans
          });
          if (ans != null ? ans.then : void 0) {
            this.nest_up(who);
            (function(_this) {
              return (function(ix) {
                return ans.then(function(result) {
                  E.log(f + 'THEN', {
                    result: result
                  });
                  out[ix] = result;
                  return _this.nest_dn(who);
                }, function(err) {
                  console.error('kids', err);
                  out[ix] = err.message;
                  return _this.nest_dn(who);
                });
              });
            })(this)(ix);
          } else {
            out[ix] = ans;
          }
        } else {
          out.push(kid);
        }
      }
      return out;
    };

    View$Base.prototype.loadPartAttrs = function(attrs, full) {
      var attr, f, result, val;
      f = 'BM/View.loadPartAttrs:';
      result = {};
      for (attr in attrs) {
        val = attrs[attr];
        if ('data-e-' !== attr.slice(0, 7)) {
          continue;
        }
        result[full ? attr : attr.slice(7)] = val;
      }
      return result;
    };

    View$Base.prototype.T_page = function(attrs) {
      var d_load, f, name, view;
      f = 'BM/View.T_page:';
      E.log(f, {
        attrs: attrs,
        date_diff: new Date().getTime() - this.start
      });
      if (this.frame_inx < this.frames.length) {
        d_load = E.oLoader.d_layout(name = this.frames[this.frame_inx++]);
        view = (this.frame_inx < this.frames.length ? 'Frame' : 'Layout') + '/' + name;
      } else {
        d_load = E.oLoader.d_page(name = this.page_name);
        view = 'Page/' + name;
      }
      return this.piece_handle(view, attrs != null ? attrs : {}, d_load);
    };

    View$Base.prototype.T_part = function(attrs) {
      var d_load, f, view;
      view = attrs.part;
      f = 'BM/View.T_part:' + view;
      E.log(f, {
        date_diff: new Date().getTime() - this.start
      });
      d_load = E.oLoader.d_part(view);
      return this.piece_handle('Part/' + view, attrs, d_load, true);
    };

    View$Base.prototype.piece_handle = function(view, attrs, obj, is_part) {
      var content, f, saved_info;
      f = 'BM/View.piece_handle:';
      E.log(f, {
        view: view,
        obj: obj,
        typeof_content: typeof obj.content,
        has_then: ((obj != null ? obj.then : void 0) ? 'yes' : 'no')
      });
      if (obj != null ? obj.then : void 0) {
        return this.D_piece(view, attrs, obj, is_part);
      }
      E.log(f, {
        view: view
      });
      content = obj.content;
      if (obj === false) {
        E.log(f + 'AFTER ASSIGN', {
          view: view,
          obj: obj
        });
      }
      saved_info = this.saveInfo();
      this.P.push(this.loadPartAttrs(attrs));
      content = this.handleIt(content);
      this.restoreInfo(saved_info);
      return content;
    };

    View$Base.prototype.D_piece = function(view, attrs, d_load, is_part) {
      var d_result, f, saved_info, who;
      f = 'BM/View.D_piece:';
      who = 'P';
      this.nest_up(who + view);
      saved_info = this.saveInfo();
      d_result = d_load.then((function(_this) {
        return function(obj) {
          var result;
          E.log(f + 'THEN', {
            obj: obj
          });
          try {
            if (obj != null ? obj.then : void 0) {
              BLOWUP();
            }
            _this.restoreInfo(saved_info);
            result = _this.piece_handle(view, attrs, obj, is_part);
            return result;
          } finally {
            _this.nest_dn(who + view);
          }
        };
      })(this), (function(_this) {
        return function(err) {
          console.error('D_piece', err);
          _this.nest_dn(who + view + ' IN-ERROR');
          return typeof _this._Err === "function" ? _this._Err('tag', 'page/part', attrs, err) : void 0;
          throw err;
        };
      })(this));
      return d_result;
    };

    View$Base.prototype.T_if_true = function(attrs, content) {
      if (this.N[attrs.name]) {
        return this.handleIt(content());
      } else {
        return '';
      }
    };

    View$Base.prototype.T_if_false = function(attrs, content) {
      if (this.N[attrs.name]) {
        return '';
      } else {
        return this.handleIt(content);
      }
    };

    View$Base.prototype.T_if = function(attrs, content) {
      var is_true, issue, ref, ref1, tbl;
      issue = false;
      is_true = false;
      if ('val' in attrs) {
        if ('eq' in attrs) {
          if (attrs.val === attrs.eq) {
            is_true = true;
          }
        } else if ('ne' in attrs) {
          if (attrs.val !== attrs.ne) {
            is_true = true;
          }
        } else if ('gt' in attrs) {
          if (attrs.val > attrs.gt) {
            is_true = true;
          }
        } else if ('in_list' in attrs) {
          if (ref = attrs.val, indexOf.call(attrs.in_list.split(','), ref) >= 0) {
            is_true = true;
          }
        } else if ('not_in_list' in attrs) {
          if (ref1 = attrs.val, indexOf.call(attrs.not_in_list.split(','), ref1) < 0) {
            is_true = true;
          }
        } else {
          issue = true;
        }
      } else if ('set' in attrs) {
        is_true = attrs.set ? true : false;
      } else if ('not_set' in attrs) {
        is_true = attrs.not_set ? false : true;
      } else if ('table_is_empty' in attrs) {
        tbl = this._accessModelTable(attrs.table_is_empty, false);
        if (!tbl.length) {
          is_true = true;
        }
      } else if ('table_is_not_empty' in attrs) {
        tbl = this._accessModelTable(attrs.table_is_not_empty, false);
        if (tbl.length) {
          is_true = true;
        }
      } else {
        issue = true;
      }
      if (issue) {
        console.error('ISSUE T_if', attrs);
      }
      if ('name' in attrs) {
        this.N[attrs.name] = is_true;
      }
      if (is_true && content) {
        return this.handleIt(content);
      } else {
        return '';
      }
    };

    View$Base.prototype._accessModelTable = function(at_table, alias) {
      var lh, ref, rh, rh_alias, root, tbl;
      ref = at_table.split('/'), lh = ref[0], rh = ref[1];
      if (lh in this.R) {
        tbl = this.R[lh][rh];
        root = {
          p: lh
        };
      } else {
        tbl = E[lh](rh);
        root = {
          m: lh
        };
      }
      if (alias === false) {
        return tbl;
      }
      rh_alias = alias != null ? alias : rh;
      if (tbl.length === 0) {
        return [tbl, rh_alias];
      }
      root.o = rh;
      this.I[rh_alias] = root;
      return [tbl, rh_alias];
    };

    View$Base.prototype.T_foreach = function(attrs, content_f) {
      var count, f, i, len, limit, ref, result, rh_alias, row, tbl;
      f = 'BM/View.T_foreach:';
      E.log(f, {
        attrs: attrs
      });
      ref = this._accessModelTable(attrs.table, attrs.alias), tbl = ref[0], rh_alias = ref[1];
      if (tbl.length === 0) {
        return '';
      }
      result = [];
      limit = 'limit' in attrs ? Number(attrs.limit) - 1 : tbl.length;
      for (count = i = 0, len = tbl.length; i < len; count = ++i) {
        row = tbl[count];
        row._ = {
          count: count,
          first: count === 0,
          last: count === limit - 1,
          "break": false
        };
        this.R[rh_alias] = row;
        this.I[rh_alias].c = count;
        result.push(this.handleIt(content_f));
      }
      delete this.I[rh_alias];
      delete this.R[rh_alias];
      return result;
    };

    View$Base.prototype.T_fist = function(attrs, content_f) {
      var ans, content, f, fist, foreach_attrs, masterAlias, model, part, ref, ref1, ref2, ref3, ref4, ref5, ref6, ref7, rh_1, rh_alias, subTable, table, tbl;
      f = 'BM/View.T_fist:';
      E.log(f, {
        attrs: attrs,
        content_f: content_f
      });
      fist = E.fistDef[attrs.fist];
      model = (ref = fist.event) != null ? ref : 'Fist';
      table = attrs.fist + (((ref1 = attrs.row) != null ? ref1.length : void 0) ? ':' + attrs.row : '');
      subTable = (ref2 = (ref3 = attrs.via) != null ? ref3 : fist.via) != null ? ref2 : 'Control';
      masterAlias = '__Fist';
      ref4 = this._accessModelTable(model + '/' + table, masterAlias), tbl = ref4[0], rh_alias = ref4[1];
      E.log(f, {
        tbl: tbl,
        rh_alias: rh_alias
      });
      this.R[rh_alias] = tbl[0];
      this.I[rh_alias].c = 0;
      rh_1 = rh_alias;
      content = content_f ? content_f : (part = (ref5 = (ref6 = attrs.part) != null ? ref6 : fist.part) != null ? ref5 : 'fist_default', attrs.part != null ? attrs.part : attrs.part = (ref7 = fist.part) != null ? ref7 : 'fist_default', (function(_this) {
        return function() {
          return _this.kids([
            [
              'part', E.merge({
                part: part
              }, _this.loadPartAttrs(attrs, true))
            ]
          ]);
        };
      })(this));
      foreach_attrs = {
        table: masterAlias + '/' + subTable
      };
      if (attrs.alias != null) {
        foreach_attrs.alias = attrs.alias;
      }
      ans = this.T_foreach(foreach_attrs, content);
      delete this.R[rh_1];
      delete this.I[rh_1];
      return ans;
    };

    View$Base.prototype.ex = function(el, isInit, ctx) {
      var attrs, d, e, f, i, ix, nm, p1, p2, ref, ref1, results, val;
      f = 'BM/View.ex:';
      attrs = el.attributes;
      results = [];
      for (ix = i = 0, ref = attrs.length; 0 <= ref ? i < ref : i > ref; ix = 0 <= ref ? ++i : --i) {
        if (!('data-ex-' === attrs[ix].name.slice(0, 8))) {
          continue;
        }
        ref1 = attrs[ix].name.split('-'), d = ref1[0], e = ref1[1], nm = ref1[2], p1 = ref1[3], p2 = ref1[4];
        val = attrs[ix].value;
        E.log(f, {
          name: attrs[ix].name,
          val: val,
          p1: p1,
          p2: p2
        });
        E.option.ex1(nm, attrs[ix].name);
        results.push(E['ex$' + nm](el, isInit, ctx, val, p1, p2));
      }
      return results;
    };

    return View$Base;

  })(E.ModelJS);

  E.Model.View$Base = View$Base;

}).call(this);
